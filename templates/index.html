<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Online Resource Saver</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
    <div id='root'></div>
    <body class="background">
        <script type="text/babel">

            const App = () => {

                const [loadingDone, setLoadingDone] = React.useState(false)
                const [categories, setCategories] = React.useState(["All"])
                const [rowsData, setRowsData] = React.useState([])

                 React.useEffect(() => {
                     try {
                        fetch('/get_data_on_page_load')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Failed to submit entry');
                                }
                                return response.json();
                            })
                            .then(responseData => {
                                let uniqueCategories = new Set(categories);
                                const tempResultArray = []

                                for (let i = 0; i < responseData.collections.length; i++) {
                                    if (!uniqueCategories.has(responseData.collections[i].category)) {
                                        uniqueCategories.add(responseData.collections[i].category);
                                    }
                                    let { name, link, category } = responseData.collections[i];
                                    tempResultArray.push({ name, link, category });
                                }

                                setRowsData(tempResultArray)
                                setCategories(Array.from(uniqueCategories));
                                setLoadingDone(true)
                            })
                            .catch(error => {
                                console.error('Error submitting entry:', error);
                            });
                    } catch (error) {
                        console.error('Error submitting entry:', error);
                    }
                }, [])

                return (
                    <>
                        <h1 className="main-title">Online Resource Saver</h1>
                        {loadingDone ? <MainTable rowsData={rowsData} categories={categories} setCategories={setCategories} /> : null}
                    </>
                )
            }

            const MainTable = ({rowsData, categories, setCategories}) => {

                return (
                    <>
                        <div className="container">
                            <div className="row">
                                <ul className="nav nav-pills mb-3 mx-auto mt-3" id="pills-tab" role="tablist">
                                    {categories.map((category, index) => (
                                        <li className="nav-item" role="presentation" key={index}>
                                            <button className={`nav-link ${index === 0 ? 'active' : ''}`}
                                                    id={`pills-${category.split(' ').join('')}-tab`} data-bs-toggle="pill"
                                                    data-bs-target={`#pills-${category.split(' ').join('')}`} type="button" role="tab"
                                                    aria-controls={`pills-${category.split(' ').join('')}`}
                                                    aria-selected={index === 0 ? 'true' : 'false'}>{category}</button>
                                        </li>
                                    ))}
                                </ul>
                                <div className="tab-content" id="pills-tabContent">
                                    {categories.map((category, index) => (
                                        <div className={`tab-pane fade ${index === 0 ? 'show active' : ''}`}
                                             id={`pills-${category.split(' ').join('')}`} role="tabpanel"
                                             aria-labelledby={`pills-${category.split(' ').join('')}-tab`} key={index}>
                                            <Table rowsData={rowsData} categories={categories} setCategories={setCategories} index={index} currentCategory={category}/>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </>
                );
            }

            const Table = ({rowsData, categories, setCategories, index, currentCategory}) => {

                const [rows, setRows] = React.useState([])

                React.useEffect(() => {
                    let rowsArr = []

                    for(let i = 0; i < rowsData.length; i++) {
                        if(rowsData[i].category === currentCategory) {
                            let { name, link, category } = rowsData[i];
                            rowsArr.push({ name, link, category });
                        }
                    }
                    setRows(rowsArr)
                }, [])

                const handleDeleteCategory = (index, currentCategory) => async() => {

                    try {
                            const response = await fetch('/delete_category', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: currentCategory
                            });

                            if (response.ok) {
                                const newCategories = categories.filter((category, i) => i !== index);
                                setCategories(newCategories)
                                setRows([])
                            } else {
                                throw new Error('Failed to submit entry');
                            }
                        } catch (error) {
                            console.error('Error submitting entry:', error);
                        }
                }

                return (
                    <>
                        {index !== 0 ? <button type="button" className="btn btn-outline-danger"
                                onClick={handleDeleteCategory(index, currentCategory)}>Delete Current Category
                        </button> : null}
                        <InputGroup setRows={setRows} rows={rows} setCategories={setCategories}
                                    categories={categories} currentCategory={currentCategory}></InputGroup>
                        <table className="table table-striped table-dark table-hover table-bordered">
                            <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Name</th>
                                <th scope="col">Link</th>
                                <th scope="col">Delete</th>
                            </tr>
                            </thead>
                            <tbody>
                            {rows.map(({link, name}, index) => (
                                <Row key={index}
                                     index={index}
                                     link={link}
                                     name={name}
                                     rows={rows}
                                     setRows={setRows}
                                     currentCategory={currentCategory}
                                />
                            ))}
                            </tbody>
                        </table>
                    </>
                )
            }

            const Row = ({index, link, name, rows, setRows, currentCategory}) => {

                const handleDelete = (index, currentCategory) => async() => {

                    const data = {
                        currentCategory: currentCategory,
                        index: index
                    }

                    try {
                            const response = await fetch('/delete_row', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(data)
                            });

                            if (response.ok) {
                                const newRows = rows.filter((row, i) => i !== index);
                                setRows(newRows)
                            } else {
                                throw new Error('Failed to submit entry');
                            }
                        } catch (error) {
                            console.error('Error submitting entry:', error);
                        }
                }

                return (
                    <>
                        <tr>
                            <th scope="row">{index + 1}</th>
                            <td>{name}</td>
                            <td><a href={link}>{link}</a></td>
                            <td>
                                <button type="button" className="btn btn-outline-danger"
                                        onClick={handleDelete(index, currentCategory)}>Delete Row
                                </button>
                            </td>
                        </tr>
                    </>
                )
            }

            const InputGroup = ({setRows, rows, setCategories, categories, currentCategory}) => {

                const [name, setName] = React.useState('');
                const [link, setLink] = React.useState('');
                const [category, setCategory] = React.useState('')

                function isValidUrl(urlInput) {
                    try {
                        const url = new URL(urlInput);
                        return url.protocol === 'http:' || url.protocol === 'https:';
                    } catch (err) {
                        return false;
                    }
                }

                const handleSubmitEntry = async event => {

                    event.preventDefault();

                    if (name !== "" && link !== "" && isValidUrl(link)) {
                        const data = {
                            "category": currentCategory,
                            "name": name.toString(),
                            "link": link.toString()
                        }
                        try {
                            const response = await fetch('/submit_entry', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(data)
                            });

                            if (response.ok) {
                                const responseData = await response.json();
                                console.log(responseData);
                                setRows([...rows, data]);
                            } else {
                                throw new Error('Failed to submit entry');
                            }
                        } catch (error) {
                            console.error('Error submitting entry:', error);
                        }
                    }
                    else {
                        window.alert("Invalid URL or empty entries");
                    }
                };

                const handleSubmitCategory = event => {

                    if (category !== "") {
                        event.preventDefault();
                        setCategories([...categories, category.toString()]);
                    }
                    else {
                        window.alert("When adding categories you cannot have empty values")
                    }
                }

                return (
                    <>
                        <div className="input-group mb-3">
                            <input
                                type="text"
                                className="form-control"
                                placeholder="Name"
                                aria-label="Username"
                                value={name}
                                onChange={e => setName(e.target.value)}
                            />
                            <span className="input-group-text">@</span>
                            <input
                                type="text"
                                className="form-control"
                                placeholder="Link: https://example.com"
                                aria-label="Server"
                                value={link}
                                onChange={e => setLink(e.target.value)}
                            />
                            <span className="input-group-text">@</span>
                            <button type="button" className="btn btn-outline-primary" onClick={handleSubmitEntry}>Add Entry
                            </button>
                        </div>
                        <div className="input-group mb-3">
                            <input
                                type="text"
                                className="form-control"
                                placeholder="Enter Category:"
                                aria-label="Username"
                                aria-describedby="basic-addon1"
                                onChange={e => setCategory(e.target.value)}
                            />
                            <span className="input-group-text" id="basic-addon1">@</span>
                            <button type="button" id="category-button" className="btn btn-outline-primary"
                                    onClick={handleSubmitCategory}>Add Category
                            </button>
                        </div>
                    </>
                )
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App/>);
        </script>
    </body>
</html>